# Verifhai Development Dockerfile
# Based on Ubuntu 24.04 for broader tool compatibility.
# Still applies: non-root user, no curl|bash installs, allow-list permissions.
# Relaxed: read-only rootfs (for pip install -e), outbound network access.
#
# Usage:
#   docker compose -f container/docker-compose.yml -f container/docker-compose.dev.yml up -d

FROM ubuntu:24.04 AS dev

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies (pinned versions where available)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3=3.12* \
        python3-pip=24* \
        python3-venv=3.12* \
        python3-dev=3.12* \
        git=1:2.43* \
        openssh-client=1:9.6* \
        ca-certificates \
        curl=8.5* \
        jq=1.7* \
        && \
    # Install Node.js 22 LTS for Claude Code
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y --no-install-recommends nodejs=22.* && \
    # Clean up
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install Claude Code via npm (NOT curl|bash)
ARG CLAUDE_CODE_VERSION=1.0.3
RUN npm install -g "@anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}" && \
    npm cache clean --force

# Install Python development tools
RUN pip3 install --no-cache-dir --break-system-packages \
    hatchling \
    pytest>=7.0.0 \
    pytest-cov>=4.0.0 \
    ruff>=0.1.0 \
    mypy>=1.0.0 \
    semgrep

# Create non-root user (same UID as production for consistency)
RUN groupadd -g 10001 verifhai && \
    useradd -u 10001 -g verifhai -m -d /home/verifhai -s /bin/bash verifhai

# Create application directories
RUN mkdir -p /opt/verifhai/semgrep \
             /opt/verifhai/skill \
             /opt/verifhai/templates \
             /opt/haiamm \
             /workspace && \
    chown -R 10001:10001 /workspace /home/verifhai

# Copy HAIAMM reference data
COPY haiamm-data/practices/ /opt/haiamm/practices/
COPY haiamm-data/questionnaires/ /opt/haiamm/questionnaires/
COPY haiamm-data/HAIAMM-Handbook.md /opt/haiamm/

# Copy security configuration
COPY container/security/claude-permissions.json /opt/verifhai/claude-permissions.json

# Copy Semgrep rules
COPY ci/semgrep/*.yml /opt/verifhai/semgrep/

# Copy Skill files
COPY SKILL.md /opt/verifhai/skill/
COPY workflows/ /opt/verifhai/skill/workflows/

# Copy templates
COPY templates/ /opt/verifhai/templates/

# Copy and install verifhai in editable mode
COPY pyproject.toml README.md /opt/verifhai-src/
COPY src/ /opt/verifhai-src/src/
RUN pip3 install --no-cache-dir --break-system-packages -e /opt/verifhai-src

# Copy entrypoint and healthcheck
COPY container/scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
COPY container/scripts/healthcheck.sh /usr/local/bin/healthcheck.sh
RUN chmod +x /usr/local/bin/entrypoint.sh /usr/local/bin/healthcheck.sh

# Environment
ENV HAIAMM_DATA_DIR=/opt/haiamm \
    VERIFHAI_HOME=/opt/verifhai \
    VERIFHAI_WORKSPACE=/workspace \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    CLAUDE_CODE_SETTINGS_FILE=/opt/verifhai/claude-permissions.json

# Switch to non-root user
USER 10001:10001
WORKDIR /workspace

HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
    CMD ["/usr/local/bin/healthcheck.sh"]

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["bash"]
