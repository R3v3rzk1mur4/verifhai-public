# Lab: SAML Security Testing for Python Developers - Assessments

## Assessment Overview

| Level | Questions | Passing Score | Format |
|-------|-----------|---------------|--------|
| L1 | 10 questions | 80% (8/10) | Multiple choice |
| L2 | 10 questions | 80% (8/10) | Multiple choice + scenario |
| L3 | 8 questions + practical | 80% + practical pass | Scenario + code review |

---

## Level 1 Assessment: SAML Analysis & Basic Exploitation

### Instructions
- 10 multiple choice questions
- 80% passing score required (8/10 correct)
- Time limit: 15 minutes

---

### Questions

**Q1. When intercepting a SAML response from a browser POST, what encoding must be reversed first?**

- A) Base64 decoding ✓
- B) AES-256 decryption
- C) URL encoding
- D) Hex decoding

**Explanation:** SAML responses are Base64-encoded XML carried in the `SAMLResponse` POST parameter. The first step in analysis is Base64 decoding to reveal the XML structure.

---

**Q2. Which XML element in a SAML response carries the authenticated user's identity?**

- A) `<saml:Issuer>`
- B) `<saml:Audience>`
- C) `<samlp:StatusCode>`
- D) `<saml:NameID>` ✓

**Explanation:** The `<saml:NameID>` element within `<saml:Subject>` contains the authenticated user's identity (typically email or username). This is the primary target for identity manipulation attacks.

---

**Q3. An SP does not validate the XML signature on SAML assertions. What can an attacker do?**

- A) Read encrypted assertions
- B) Forge arbitrary SAML assertions claiming any identity ✓
- C) Crash the IdP server
- D) Bypass MFA on the IdP

**Explanation:** Without signature validation, the SP trusts any well-formed SAML assertion. An attacker can construct an assertion with arbitrary NameID and role attributes — complete authentication bypass.

---

**Q4. Which Python code creates an XXE payload that reads `/etc/passwd` through a SAML response?**

- A) `etree.parse("file:///etc/passwd")`
- B) `<!ENTITY xxe SYSTEM "https://evil.com">`
- C) `<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>` ✓
- D) `<xi:include href="/etc/passwd"/>`

**Explanation:** The DOCTYPE entity declaration defines an external entity `xxe` that references the local file. When the entity `&xxe;` is used within the XML body (e.g., in a NameID element), the parser resolves it to the file contents.

---

**Q5. Which XML parser is vulnerable to XXE by default in Python?**

- A) `lxml.etree` with `resolve_entities=True` ✓
- B) `xml.sax` with default settings
- C) `defusedxml.lxml`
- D) `defusedxml.ElementTree`

**Explanation:** The `lxml` library's default parser resolves entities and can load DTDs. With `resolve_entities=True` (default) and `load_dtd=True`, external entities in SAML XML are resolved, enabling file reading and SSRF.

---

**Q6. Why must a SAML replay attack occur within the assertion's validity window?**

- A) The network connection times out
- B) IdP certificates expire every 5 minutes
- C) The Base64 encoding degrades over time
- D) Properly configured SPs check `NotOnOrAfter` and reject expired assertions ✓

**Explanation:** The `NotOnOrAfter` attribute in `<saml:Conditions>` sets the assertion's validity window (typically 5-10 minutes). SPs that check this timestamp will reject replayed assertions after expiry — but SPs that skip this check accept replays indefinitely.

---

**Q7. What does a SAML Response ID (`ID="_resp123"`) protect against?**

- A) Man-in-the-middle attacks
- B) DNS spoofing
- C) Replay attacks — the SP tracks seen IDs to reject duplicates ✓
- D) XML injection

**Explanation:** The Response ID should be unique per authentication. A properly configured SP stores seen IDs and rejects any response with a previously seen ID. Without this tracking, the same response can be replayed multiple times.

---

**Q8. When building a SAML testing script, which Python library is used to construct XML elements for forged assertions?**

- A) `lxml.etree` ✓
- B) `requests`
- C) `hashlib`
- D) `json`

**Explanation:** The `lxml.etree` library provides `Element`, `SubElement`, and `tostring` functions for constructing arbitrary XML documents. This is essential for building forged SAML responses with custom NameID, Conditions, and AttributeStatement elements.

---

**Q9. What distinguishes authorized SAML security testing from unauthorized access?**

- A) Using automated tools instead of manual testing
- B) Testing against a production IdP
- C) Having explicit written authorization and defined scope ✓
- D) Only testing during business hours

**Explanation:** Authorized penetration testing requires explicit written permission (rules of engagement) from the system owner, with clearly defined scope (which endpoints, which attack types). Testing without authorization is illegal regardless of technique or timing.

---

**Q10. A decoded SAML response shows `Destination="https://app.example.com/acs"` but you are testing `https://other-app.example.com/acs`. Which attack does this suggest?**

- A) XXE injection
- B) Cross-application assertion replay — the assertion was meant for a different SP ✓
- C) Golden SAML
- D) NameID comment injection

**Explanation:** A Destination mismatch means the assertion was generated for `app.example.com`, not `other-app.example.com`. If `other-app` does not validate the Destination field, it will accept assertions meant for a different application — a cross-application attack.

---

## Level 2 Assessment: Advanced SAML Exploitation

### Instructions
- 10 multiple choice and scenario-based questions
- 80% passing score required (8/10 correct)
- Time limit: 25 minutes

---

### Questions

**Q1. What fundamental flaw does an XML Signature Wrapping (XSW) attack exploit?**

- A) Weak XML encryption algorithms
- B) The gap between what the signature covers and what the application reads ✓
- C) Missing HTTPS on the ACS endpoint
- D) Buffer overflows in XML parsers

**Explanation:** XSW exploits the fact that the XML signature is computed over a specific element (identified by reference), but the application may extract claims from a different element in the tree. The attacker moves the signed element and inserts an unsigned one where the application looks.

---

**Q2. In an XSW Type 1 attack, what does the attacker do to the XML document tree?**

- A) Remove the signature entirely
- B) Encrypt the signed assertion
- C) Duplicate the signature element
- D) Move the signed assertion to the end and insert an unsigned assertion first ✓

**Explanation:** XSW Type 1 moves the legitimately signed assertion deeper in the tree (e.g., wraps it or appends it) and places a new, unsigned assertion with attacker-controlled claims at the position where the application reads first (e.g., the first `<Assertion>` child).

---

**Q3. Why does `<NameID>attacker@evil.com<!-- -->.legit.com</NameID>` succeed against code using `.text`?**

- A) XML comments are invalid syntax
- B) The `.text` property returns all text content including comments
- C) The `.text` property only returns text before the first child node (the comment) ✓
- D) Comments are stripped during signature validation

**Explanation:** In lxml, the `.text` property of an element returns only the text content before the first child node. An XML comment `<!-- -->` is a child node, so `.text` returns `"attacker@evil.com"` and ignores `".legit.com"` after the comment. Using `itertext()` returns the full concatenated text.

---

**Q4. An attacker captures a SAML assertion with `<Audience>https://app-A.com</Audience>` and submits it to `https://app-B.com`. Under what condition does this succeed?**

- A) When App-B has `strict: False` and does not validate the Audience restriction ✓
- B) When the assertion is encrypted
- C) When both applications use the same IdP
- D) When the attacker modifies the Audience element

**Explanation:** If App-B does not validate the `<AudienceRestriction>`, it accepts assertions intended for any SP. The `strict: False` configuration in python3-saml disables these checks, enabling cross-application assertion replay.

---

> **Scenario for Q5-Q6:** You discover that a SAML SP uses `POST /saml/acs-relay` to process SAML responses. The SP redirects users to the URL specified in the `RelayState` parameter without validation.

**Q5. What type of vulnerability does an unvalidated RelayState represent?**

- A) XML injection
- B) Session fixation
- C) Cross-site request forgery
- D) Open redirect ✓

**Explanation:** RelayState is meant to preserve the user's original destination after SAML authentication. If the SP redirects to any URL in RelayState without validating it against an allowlist, an attacker can redirect authenticated users to a phishing page or malicious site.

---

**Q6. How can an attacker chain the RelayState open redirect with a valid SAML authentication?**

- A) Modify the SAML assertion to include the redirect URL
- B) Send a legitimate SAML response with RelayState pointing to a credential-harvesting page ✓
- C) Inject JavaScript into the RelayState parameter
- D) Use RelayState to bypass signature validation

**Explanation:** The attacker initiates a legitimate SAML flow but sets RelayState to their phishing page. After the user authenticates at the real IdP, the SP processes the valid assertion then redirects to the attacker's site — the user believes they are still in a trusted flow.

---

> **Scenario for Q7-Q8:** During testing, you find that the SP creates a session after SAML authentication but does not regenerate the session ID. The session cookie has `SameSite=None` and no `Secure` flag.

**Q7. What attack does the missing session regeneration enable?**

- A) XML Signature Wrapping
- B) Golden SAML
- C) Session fixation — an attacker who pre-sets the session cookie inherits the authenticated session ✓
- D) XXE injection

**Explanation:** If the session ID is not regenerated after authentication, an attacker who sets the session cookie before the SAML flow (e.g., via a link with a `Set-Cookie` header or XSS) will share the same session. After the user authenticates, the attacker's cookie points to an authenticated session.

---

**Q8. Which additional attack does `SameSite=None` without the `Secure` flag enable?**

- A) The cookie is sent on cross-site requests AND over unencrypted HTTP ✓
- B) The cookie expires immediately
- C) The cookie is only accessible via JavaScript
- D) The session cannot be invalidated

**Explanation:** `SameSite=None` means the cookie is sent on all cross-site requests (enabling CSRF). Without the `Secure` flag, the cookie is also sent over unencrypted HTTP connections, allowing interception via network sniffing.

---

**Q9. Which attack chain achieves the MOST severe impact against a SAML SP?**

- A) Comment injection → audience bypass → cross-tenant access
- B) XXE to read IdP config → discover signing key location → Golden SAML ✓
- C) Replay → session fixation → redirect
- D) Missing HTTPS → cookie theft → session hijack

**Explanation:** The XXE → Golden SAML chain is the most severe because it achieves persistent authentication bypass for any user. XXE reads the IdP's signing key, enabling Golden SAML — forging assertions without ever touching the IdP. Password resets and MFA changes do not mitigate this.

---

**Q10. When prioritizing SAML findings in a pentest report, which factor MOST affects the severity ranking?**

- A) The number of lines of code affected
- B) How long the vulnerability took to discover
- C) Whether the vulnerability requires authentication
- D) The combination of exploitability and impact to confidentiality/integrity ✓

**Explanation:** CVSS scoring weights both exploitability (attack vector, complexity, privileges required) and impact (confidentiality, integrity, availability). A finding that is easy to exploit with high impact (e.g., authentication bypass) ranks higher than one that is complex to exploit with limited impact.

---

## Level 3 Assessment: Red Team SAML Operations

### Instructions
- 8 scenario-based questions + 1 practical exercise
- 80% on questions + passing practical required
- Time limit: 30 minutes (questions) + 45 minutes (practical)

---

### Questions

> **Scenario for Q1-Q2:** Your red team has obtained the IdP's token-signing private key through a compromised AD FS server. You plan to execute a Golden SAML attack.

**Q1. Why don't password resets mitigate a Golden SAML attack?**

- A) Password resets only affect local accounts
- B) The attacker bypasses the IdP entirely — forged assertions are signed directly, so no password is ever checked ✓
- C) Golden SAML attacks only target service accounts
- D) Password resets require the IdP signing key

**Explanation:** In a Golden SAML attack, the attacker creates and signs SAML assertions directly using the stolen key. The assertions are submitted directly to the SP's ACS endpoint. The IdP is never contacted, so password changes, MFA resets, and account lockouts have no effect.

---

**Q2. What is the ONLY effective remediation for an active Golden SAML attack?**

- A) Reset all user passwords
- B) Enable MFA for all users
- C) Rotate the IdP's token-signing certificate and update all SP trust relationships ✓
- D) Block the attacker's IP address

**Explanation:** The root cause is the compromised signing key. The only fix is rotating the IdP certificate (generating a new key pair) and updating every SP's trust configuration with the new certificate. Until this is done, the attacker can continue forging assertions.

---

> **Scenario for Q3-Q4:** You are building an automated SAML security testing toolkit that will be used by your AppSec team for recurring assessments.

**Q3. What modules should a comprehensive SAML testing toolkit include?**

- A) Response decoder, signature bypass, XXE injection, XSW variants, replay testing, and comment injection modules ✓
- B) Only signature validation testing
- C) Only XXE and XSW testing
- D) Only authentication and authorization testing

**Explanation:** A comprehensive toolkit needs modules for each attack class: response analysis (decoder), authentication bypass (signature bypass, XSW), data exfiltration (XXE), session attacks (replay), and identity manipulation (comment injection). Each module should produce structured findings.

---

**Q4. How should the toolkit handle the variety of XSW attack types (1-8)?**

- A) Only test XSW Type 1 as it is the most common
- B) Randomly select one XSW type per test run
- C) Skip XSW testing if a signature is present
- D) Generate all XSW variants and test each against the target ✓

**Explanation:** Different SP implementations are vulnerable to different XSW variants depending on how they traverse the XML tree. A thorough toolkit generates all variants (Types 1-8 per the Somorovsky taxonomy) and tests each, as the same SP may be vulnerable to some variants but not others.

---

> **Scenario for Q5-Q6:** You are writing the penetration test report for a SAML security assessment. You identified 6 findings across all severity levels.

**Q5. What CVSS 3.1 base score range is appropriate for a Golden SAML finding?**

- A) Medium (4.0-6.9)
- B) High (7.0-8.9)
- C) Low (0.1-3.9)
- D) Critical (9.0-10.0) — CVSS: AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H ✓

**Explanation:** Golden SAML enables complete authentication bypass for any user across any federated application, with persistence that survives password resets and MFA changes. The scope is Changed (affects multiple SPs), and impact is High across all three categories.

---

**Q6. Which correlation in SIEM logs is the strongest indicator of a Golden SAML attack?**

- A) Failed login attempts at the IdP
- B) Successful SP authentication events with NO corresponding IdP sign-in event ✓
- C) High volume of SAML responses
- D) Certificate errors in SP logs

**Explanation:** In a Golden SAML attack, the attacker bypasses the IdP entirely. SP logs show successful authentication, but IdP logs have no corresponding sign-in event for that user at that time. This SP-IdP correlation gap is the primary detection signal.

---

**Q7. Your report includes a finding for missing signature validation (CVSS 9.8) and a finding for missing `NotOnOrAfter` validation (CVSS 5.3). How should you present these in the executive summary?**

- A) Focus on the signature validation finding as it enables complete authentication bypass, then mention the timing validation as a contributing factor ✓
- B) List all findings equally without severity distinction
- C) Only mention the highest severity finding
- D) Average the CVSS scores

**Explanation:** Executive summaries should lead with the highest-impact finding and explain its business significance. Supporting findings that compound the risk should be mentioned but not given equal weight. Non-technical readers need to understand "what's the worst that can happen" first.

---

**Q8. After the SP team applies your recommended fix for signature validation, how should you verify the remediation?**

- A) Review the code change in a pull request
- B) Accept the team's confirmation that the fix was applied
- C) Re-run the signature bypass exploit — it should now return 401/403 instead of 200 ✓
- D) Check if the library was updated to the latest version

**Explanation:** Remediation verification requires re-testing — the same exploit that succeeded before should now fail. Code review is supplementary but not sufficient (the fix might be incomplete or have a logic error). The definitive test is attempting the attack and confirming it is blocked.

---

### Practical Exercise: Complete SAML Penetration Test

**Scenario:** You have been authorized to perform a security assessment of a SAML Service Provider implementation. The vulnerable application is running at `http://127.0.0.1:5001` (the `vulnerable-saml-app.py` training target).

Your assessment scope includes all SAML ACS endpoints listed at `GET /`. You may use the `/generate` endpoint to create test SAML responses and the `/idp-metadata` endpoint for IdP certificate material.

**Deliverables:**

1. **Reconnaissance report** documenting all SAML endpoints, their behavior, and identified attack surface
2. **Exploit PoC scripts** for at least 5 distinct vulnerability classes (signature bypass, XXE, XSW, comment injection, replay, and/or Golden SAML)
3. **Findings report** with severity ratings (CVSS 3.1), steps to reproduce, impact analysis, and remediation recommendations for each finding
4. **Executive summary** (3-5 sentences) suitable for non-technical stakeholders
5. **Remediation verification plan** describing how to confirm each fix is effective

**Evaluation Criteria:**

| Criterion | Pass Requirement |
|-----------|------------------|
| Reconnaissance | Identifies all 9 planted vulnerabilities across all endpoints |
| Exploit Quality | At least 5 working PoC scripts that demonstrate exploitation |
| XSW Construction | Demonstrates at least one XSW variant with correct XML manipulation |
| Finding Severity | CVSS scores within 1 point of reference values |
| Remediation | Specific, actionable fix for each finding (not generic) |
| Report Quality | Professional format with evidence, reproducible steps |

---

## Answer Keys

### L1 Answers
1-A, 2-D, 3-B, 4-C, 5-A, 6-D, 7-C, 8-A, 9-C, 10-B

### L2 Answers
1-B, 2-D, 3-C, 4-A, 5-D, 6-B, 7-C, 8-A, 9-B, 10-D

### L3 Answers
1-B, 2-C, 3-A, 4-D, 5-D, 6-B, 7-A, 8-C
Practical: Rubric-based evaluation

---

**Document Version:** 1.0
**Framework:** HAIAMM v2.0
**Practice:** Education & Guidance (EG)
**Domain:** Software (Lab)
**Author:** Verifhai
