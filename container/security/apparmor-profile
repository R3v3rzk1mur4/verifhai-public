# Verifhai AppArmor Profile
# Confines the container to specific file paths and network operations.
# Load with: apparmor_parser -r -W container/security/apparmor-profile
# Verify with: aa-status | grep verifhai

#include <tunables/global>

profile verifhai-container flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/python>

  # === File Access Rules ===

  # Verifhai application (read-only)
  /opt/verifhai/** r,
  /opt/verifhai/semgrep/** r,
  /opt/verifhai/skill/** r,
  /opt/verifhai/templates/** r,
  /opt/verifhai/claude-permissions.json r,

  # HAIAMM data (read-only)
  /opt/haiamm/** r,
  /opt/haiamm/practices/** r,
  /opt/haiamm/questionnaires/** r,
  /opt/haiamm/HAIAMM-Handbook.md r,

  # Workspace (read-write - user's working directory)
  /workspace/** rw,
  /workspace/ r,

  # Temporary files (read-write)
  /tmp/** rw,
  /tmp/ r,
  /tmp/.verifhai/** rw,

  # Home directory for verifhai user
  /home/verifhai/** rw,
  /home/verifhai/ r,
  /home/verifhai/.claude/** rw,

  # Python runtime (read + execute)
  /usr/bin/python* rix,
  /usr/lib/python*/** r,
  /usr/local/lib/python*/** r,
  /usr/local/bin/python* rix,
  /usr/local/bin/verifhai rix,

  # Node.js runtime for Claude Code (read + execute)
  /usr/local/bin/node rix,
  /usr/local/bin/claude rix,
  /usr/local/lib/node_modules/** r,

  # System libraries (read + execute for shared objects)
  /lib/** rm,
  /lib64/** rm,
  /usr/lib/** rm,
  /usr/lib64/** rm,

  # System files needed for runtime
  /etc/passwd r,
  /etc/group r,
  /etc/nsswitch.conf r,
  /etc/resolv.conf r,
  /etc/hosts r,
  /etc/ssl/certs/** r,
  /etc/ca-certificates/** r,
  /etc/localtime r,
  /etc/timezone r,

  # Proc filesystem (limited)
  /proc/ r,
  /proc/self/** r,
  /proc/sys/kernel/random/uuid r,
  /proc/sys/kernel/random/boot_id r,
  /proc/sys/kernel/osrelease r,
  /proc/sys/kernel/ngroups_max r,
  /proc/sys/vm/overcommit_memory r,
  /proc/filesystems r,
  /proc/meminfo r,
  /proc/cpuinfo r,
  /proc/stat r,
  /proc/uptime r,
  /proc/loadavg r,
  # Deny access to other process information
  deny /proc/*/mem rwklx,
  deny /proc/*/maps r,
  deny /proc/*/environ r,
  deny /proc/kcore r,
  deny /proc/sysrq-trigger rw,

  # Deny dangerous filesystem access
  deny /sys/firmware/** rwklx,
  deny /sys/kernel/security/** rwklx,
  deny /sys/fs/cgroup/** w,
  deny /boot/** rwklx,
  deny /dev/mem rwklx,
  deny /dev/kmem rwklx,
  deny /dev/port rwklx,

  # === Capability Rules ===
  # Deny all capabilities - container drops ALL
  deny capability,

  # === Network Rules ===
  # Allow outbound TCP (HTTPS to api.anthropic.com)
  network inet stream,
  network inet6 stream,
  # Allow DNS resolution
  network inet dgram,
  network inet6 dgram,
  # Deny raw sockets (no network scanning)
  deny network raw,
  deny network packet,

  # === Mount Rules ===
  deny mount,
  deny umount,
  deny pivot_root,

  # === Ptrace Rules ===
  deny ptrace,

  # === Signal Rules ===
  # Allow signals within the container
  signal (send, receive) peer=verifhai-container,

  # === Execution Rules ===
  # Allow execution of these specific binaries only
  /usr/bin/env rix,
  /usr/bin/sh rix,
  /bin/sh rix,
  /usr/bin/git rix,
  /usr/bin/semgrep rix,
  /usr/local/bin/semgrep rix,
  /usr/bin/find rix,
  /usr/bin/grep rix,
  /usr/bin/sort rix,
  /usr/bin/uniq rix,
  /usr/bin/wc rix,
  /usr/bin/diff rix,
  /usr/bin/id rix,

  # Deny execution of dangerous tools
  deny /usr/bin/curl x,
  deny /usr/bin/wget x,
  deny /usr/bin/sudo x,
  deny /usr/bin/su x,
  deny /usr/sbin/** x,
  deny /sbin/** x,
}
